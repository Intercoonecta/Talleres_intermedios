---
title: "Datos temporales en R"
author: "Héctor Villalobos"
format: 
  gfm:
    toc: false
editor: visual
---

## Introducción

Hablamos de datos temporales cuando las variables que se recolectan tienen asociada una fecha y posiblemente una hora. El uso correcto de estos datos depende de definir con toda claridad el formato en que esta información se almacena. Por ejemplo, en los archivos (ascii o Excel) se puede guardar el año, mes y día en columnas separadas, o combinados en una misma columna como una cadena de texto o bien en un formato especializado de fecha (en el caso de Excel).

Usualmente se usan solo números, por lo que tendríamos algo así como "30-09-2024" (dd-mm-aaaa), aunque en algunos casos podría escribirse como "2024/Sep/30" (aaaa/mmm/dd). El tiempo podría estar en una columna aparte o también combinado con la fecha: "2024-09-30 15:30:58" (aaaa-mm-dd hh:mm:ss).

Lo importante en todos los casos es la consistencia, y sobretodo no invertir el orden del mes y el día ni escribir indistintamente "Sep", "sep" y "Septiembre" . Es sumamente importante revisar esto antes de importar los datos en R.

![](fechas.jpg){fig-align="center" width="266"}

Al importar en R desde archivos ascii con la función `read.table()`, la clase de la variable con la fecha será `"character"`, lo cual dificultará su uso en gráficos o para realizar operaciones, por lo que debemos convertirlos a una clase apropiada para fecha o fecha-tiempo. En cambio, al importar archivos Excel con la función `read_excel()` del paquete **readxl** usualmente ya pasan como clase `POSIXct`, si el formato no es ambiguo. A continuación se describen algunas de estas clases especializadas.

## Clase `"Date"` 

Esta es tal vez la clase más sencilla cuando solo tenemos fechas.

```{r}
fechas <- paste("2024", c("09", "10", "11", "12"), c("13", "18", "25", "31"), sep ="-")
fechas
```

En el ejemplo, el vector `fechas` es de clase `"character"`.

```{r}
class(fechas)
```

La conversión a la clase `"Date"` se logra con la función `as.Date().`

```{r}
fechas <- as.Date(fechas)
fechas
class(fechas)
```

Esta clase representa el número de días desde el 1 de enero de 1970.

```{r}
unclass(fechas)
origen <- as.Date("1970-01-01")
```

La resta siguiente nos debe dar los mismos valores obtenidos con `unclass(fechas)`.

```{r}
fechas - origen
```

Con la función `Sys.time()` podemos obtener la fecha-hora actual de acuerdo a la configuración local de nuestra computadora.

```{r}
ahora <- Sys.time()
ahora
```

Al aplicar la función `as.Date()` la hora se descarta.

```{r}
as.Date(ahora)
```

## La clase `"POSIXlt"`

Las clases más utilizadas en R que permiten guardar la fecha, hora y la zona de tiempo son **"POSIXlt"** y **"POSIXct"**. La primera almacena esta información como una lista de vectores `sec`, `min`, `hour` para el tiempo; `mday`, `mon` y `year` para la fecha; `wday` y `yday` para el día de la semana y el día del año, respectivamente;`isdst`, es una bandera para el horario de verano; `zone` es una cadena de texto para la zona de tiempo; y `gmtoff` sería el *offset* en segundos del horario GMT. La función `strptime()` nos permite convertir una cadena de texto a la clase `"POSIXlt"`.

```{r}
dt <- strptime("2024-10-08 14:12:30", format = "%Y-%m-%d %H:%M:%S", tz = "UTC")
dt
class(dt)
```

Pare ver los vectores mencionados antes, usamos nuevamente la función `unclass()`.

```{r}
unclass(dt)
```

También podemos usar la función `as.POSIXlt()` con el mismo propósito, y si no lo indicamos la zona de tiempo se ajustará de acuerdo a nuestra configuración.

```{r}
psx.lt <- as.POSIXlt("2024-10-08 14:12:30")
psx.lt
class(psx.lt)
```

## La clase `"POSIXct"`

Esta clase representa el número de segundos desde el primero de enero de 1970 (en UTC) como un vector numérico.

```{r}
psx.ct <- as.POSIXct("2024-10-08 14:12:30", tz = "UTC")
psx.ct
class(psx.ct)
```

Aplicando la función `unclass()` podemos ver el número de segundos transcurridos desde el origen mencionado antes.

```{r}
unclass(psx.ct)
```

Esto lo podemos comprobar fácilmente.

```{r}
# definir origen
orig <- as.POSIXct("1970-01-01 00:00:00", format = "%Y-%m-%d %H:%M:%S", tz = "UTC") 

# calcular la diferencia entre psx.ct y el origen
difftime(psx.ct, orig, units = "s")
```

De acuerdo con la ayuda de R, la clase `"POSIXct"` es más conveniente para incluirse en data frames, mientras que `"POSIXlt"`es una forma más fácil de leer para el humano.

## Manipulación de datos temporales: temperatura potencial del mar diaria

Datos diarios de temperatura

```{r}
# cargar paquete devtools
#library(devtools)

# instalar 'satin' desde github
#install_github("hvillalo/satin")

# cargar paquete satin
library(satin)
```

Importar datos de Copernicus

```{r}
thetao <- read.cmems("./datos/cmems_mod_glo_phy_my_0.083deg_P1D-m_1728505215428.nc")
```

inspeccionar objeto thetao

```{r}
class(thetao)
```

usaremos la temperatura potencial, thetao

```{r}
thetao
```

En este tenemos 731 días , del 2019-01-01 al 2020-12-31

```{r}
head(thetao@period$tmStart); tail(thetao@period$tmStart)
```

Haremos un mapa para elegir un punto y extraer los valores de temperatura en el nivel más superficial

```{r}
plot(thetao)
```

Tomemos por ejemplo un pixel a los 26° de lat N y 110° de lon W

```{r}
pt <- data.frame(x = -110, y = 26)
sst <- extractPts(thetao, points = pt)
dim(sst)
```

En sst están los valores de temperatura potencial para el punto seleccionado, en los 731 díasy para los 5 niveles de profundidad 731 $\times$ 5 = 3655. Las primeras seis columnas adicionales en sst contienen el id del punto o puntos elegidos, las coordenadas de latitud-longitud elegidas, las coordenadas del pixel más cercano donde hay datos y la distancia entres el punto elegido y el dato devuelto, solo como un control

```{r}
sst[ , 1:10]
```

Para repesentar la serie de tiempo podemos rearreglar nuestros datos extraidos de la siguiente manera

```{r}
fecha <- thetao@period$tmStart
tsm <- data.frame(fecha, temperatura = t(sst[ , 7:(731+6)]))
head(tsm)
```

Figura

```{r}
plot(tsm, type = "b", pch = 16, col = rgb(1, 0, 0, 0.2))
```

Si quisieramos los promedios mensuales

```{r}
library(lubridate)
tsm$mes <- month(tsm$fecha)
tsm$año <- year(tsm$fecha)
head(tsm)
```

Suavizado con promedios móviles

```{r}
library(smooth)
sm <- cma(tsm$temperatura, order = 30)
tsm$sm <- sm$fitted

plot(tsm$fecha, tsm$temperatura, type = "b", pch = 16, col = rgb(1, 0, 0, 0.2),
     xlab = "día", ylab = "temperatura")
lines(tsm$fecha, tsm$sm, lwd = 2)
```

Agregar por año mes

```{r}
tsm.mens <- aggregate(tsm$temperatura, by = list(mes = tsm$mes, año = tsm$año), mean)
head(tsm.mens)
```

```{r}
plot(as.Date(paste(tsm.mens$año, tsm.mens$mes, 15, sep = "-")), tsm.mens$x,
     xlab = "mes", ylab = "temperatura (°C)", type = "b")
```

\
